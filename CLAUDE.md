# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Meo Mai Moi is a pet care management platform with rehoming features. It's a monorepo with a Laravel 12 backend API and React 19 frontend SPA. PostgreSQL only (no SQLite).

## Quick Commands

### Development

```bash
./utils/deploy.sh --seed          # Start everything with sample data
docker compose up -d --build      # Manual Docker start
```

### Backend (from backend/)

```bash
php artisan test --parallel       # Run tests
composer phpstan                  # Static analysis (Level 5)
composer deptrac                  # Architecture validation
./vendor/bin/pint                 # Format code
php artisan l5-swagger:generate   # Regenerate OpenAPI spec
```

### Frontend (from frontend/)

```bash
bun run test:minimal              # Fast test run (minimal output)
bun run test                      # Verbose test run
bun run typecheck                 # TypeScript check
bun run lint                      # ESLint
bun run api:generate              # Regenerate API client from OpenAPI
bun run e2e                       # E2E tests. docs/e2e.md for details
```

### Root Workspace

```bash
bun run api:generate              # Regenerate both OpenAPI spec and frontend client
bun run api:check                 # Verify generated code matches spec
```

## Architecture

### Backend Layers (Enforced by Deptrac)

```
Http (Controllers, Middleware, Requests, Resources)
  ↓
Services (Business Logic)
  ↓
Domain (Models, Enums, Policies)
```

- **Controllers are thin** - delegate to Services
- **All endpoints** use `ApiResponseTrait` for standardized `{ success, data, message }` envelope
- **Authorization** via Policies with `$user->can(...)`
- **OpenAPI annotations** (`#[OA\*]`) on controllers generate the spec

### Frontend Structure

```
src/
├── api/generated/     # Auto-generated by Orval (DO NOT EDIT)
├── components/ui/     # shadcn/ui primitives
├── components/        # Feature components
├── pages/             # Route pages (don't import other pages)
├── hooks/             # Custom React hooks
└── lib/               # Utilities
```

- **State**: React Query (server), React Hook Form (forms), AuthProvider (auth context)
- **API Client**: Generated via Orval from OpenAPI spec - run `bun run api:generate` after backend API changes

### Key Patterns

**API Response Envelope** - All backend endpoints return:

```json
{ "success": true, "data": {}, "message": "..." }
```

**Pet Relationships** - The `PetRelationship` model supports multiple concurrent relationship types (owner, foster, editor, viewer) for flexible pet sharing.

## Testing

- **Backend tests** require `PetTypeSeeder` to run for pet-related tests
- **E2E tests** use MailHog for real email testing (UI at http://localhost:8025)
- **MSW handlers** in frontend must mirror the `{ data: ... }` API shape

## Important Files

- `backend/app/Traits/ApiResponseTrait.php` - Response standardization
- `frontend/src/api/orval-mutator.ts` - Custom Axios mutator for envelope handling
- `backend/deptrac.yaml` - Architectural layer rules
- `utils/deploy.sh` - Single deployment entry point

## Access Points

- App: http://localhost:8000
- Admin: http://localhost:8000/admin (admin@catarchy.space / password)
- API Docs: http://localhost:8000/api/documentation

## Workflow Notes

- Frontend builds into `backend/public/build/` via Docker multi-stage build
- Email config is database-driven via Filament admin (overrides .env)
- Run `bun run api:generate` after any backend API changes to sync frontend types
