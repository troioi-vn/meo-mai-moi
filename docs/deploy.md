# Production Deployment Guide

Safe, repeatable, and rollback-friendly steps for deploying Meo Mai Moi.

TL;DR
- docker compose exec backend php artisan down
- ./scripts/backup.sh
- git pull origin main   # default production branch; adjust if different
- docker compose pull    # optional: if you use prebuilt images from a registry
- docker compose up -d --build
- docker compose exec backend php artisan migrate --force
- docker compose exec backend php artisan optimize:clear
- docker compose exec backend php artisan up
- Verify: docker compose ps && docker compose logs backend && open site

Prerequisites
- docker and docker compose installed
- Repo cloned and working directory at project root
- Scripts executable: chmod +x scripts/backup.sh scripts/restore.sh

Environment and assets
- Docker passes env via backend/.env.docker; container ensures /var/www/.env and APP_KEY (handled by entrypoint when missing).
- Frontend assets are built as part of the Docker image build (vite build + copy to backend/public/build). No extra steps needed on server besides docker compose up -d --build.

First-time notes (one-time per server)
- Set proper values in backend/.env.docker (APP_URL, DB_*, MAIL_*). APP_KEY is auto-generated by entrypoint if absent.
- Ensure volumes/permissions allow the container user (www-data) to write storage and cache.
- DNS/SSL: terminate TLS via a reverse proxy (Caddy/Traefik/Nginx) in front of this stack.

Deployment workflow
Phase 1: Prepare
1) Maintenance mode
    - docker compose exec backend php artisan down
2) Backup
    - ./scripts/backup.sh  # DB + uploads to scripts/backups/

Phase 2: Deploy
3) Pull latest
    - git pull origin main  # or your prod branch
    - docker compose pull   # optional: if images are pulled from a registry
4) Rebuild + restart
    - docker compose up -d --build
5) DB migrations
    - docker compose exec backend php artisan migrate --force
6) Clear caches
    - docker compose exec backend php artisan optimize:clear

Phase 3: Go live and verify
7) Disable maintenance
    - docker compose exec backend php artisan up
8) Verify
    - docker compose ps
    - docker compose logs backend | tail -n 100
    - Health endpoint: curl -f http://localhost:8000/api/version
    - Admin panel responds: curl -I http://localhost:8000/admin | head -n 1  # Expect HTTP/1.1 302 or 200
    - Manual check: open http://localhost:8000/admin and sign in

Emergency rollback
1) Maintenance mode
    - docker compose exec backend php artisan down
2) Restore backup
    - ./scripts/restore.sh  # interactive: DB and/or uploads
3) Revert code
    - git log
    - git checkout <good-commit>
4) Re-deploy old version
    - docker compose up -d --build
    - docker compose exec backend php artisan migrate --force
    - docker compose exec backend php artisan optimize:clear
5) Disable maintenance
    - docker compose exec backend php artisan up