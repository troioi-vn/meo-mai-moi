# Internationalization (i18n)

This document describes the internationalization implementation for Meo Mai Moi, covering both backend (Laravel) and frontend (React) parts.

## Overview

### Supported Languages

| Code | Language | Status    |
| ---- | -------- | --------- |
| `en` | English  | Default   |
| `ru` | Russian  | Supported |

### Architecture

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              Frontend                                    │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────────────────┐  │
│  │ react-i18next│◄───│ JSON files   │    │ Accept-Language header   │  │
│  │ useTranslation│   │ en/*.json    │    │ sent with all API calls  │  │
│  └──────────────┘    │ ru/*.json    │    └────────────┬─────────────┘  │
│                      └──────────────┘                  │                │
└────────────────────────────────────────────────────────│────────────────┘
                                                         │
                                                         ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                              Backend                                     │
│  ┌──────────────────┐    ┌──────────────┐    ┌─────────────────────┐   │
│  │ SetLocaleMiddleware│──►│ App::setLocale│──►│ __() helper returns │   │
│  │ (reads header)    │    │              │    │ translated strings  │   │
│  └──────────────────┘    └──────────────┘    └─────────────────────┘   │
│                                                                          │
│  ┌──────────────┐                                                        │
│  │ PHP files    │                                                        │
│  │ lang/en/*.php│                                                        │
│  │ lang/ru/*.php│                                                        │
│  └──────────────┘                                                        │
└─────────────────────────────────────────────────────────────────────────┘
```

### Key Concepts

1. **Frontend translations**: UI labels, buttons, form fields are translated client-side using react-i18next
2. **Backend translations**: API response messages, validation errors are translated server-side using Laravel's `__()` helper
3. **Locale detection**: Automatically detects user's preferred language from browser settings
4. **Locale persistence**: Authenticated users can save their preference to the database

---

## Backend Implementation

### Directory Structure

```
backend/
├── lang/
│   ├── en/
│   │   ├── messages.php      # General API messages
│   │   └── validation.php    # Form validation messages
│   └── ru/
│       ├── messages.php
│       └── validation.php
├── app/
│   ├── Http/
│   │   ├── Middleware/
│   │   │   └── SetLocaleMiddleware.php
│   │   └── Controllers/
│   │       └── LocaleController.php
│   └── Models/
│       └── User.php          # Has 'locale' column
└── database/
    └── migrations/
        └── xxxx_add_locale_to_users_table.php
```

### Middleware: SetLocaleMiddleware

Located at `app/Http/Middleware/SetLocaleMiddleware.php`

Determines locale using this priority:

1. **Authenticated user's database preference** (highest priority)
2. **Accept-Language HTTP header** (for guests or new sessions)
3. **Default fallback** (`en`)

The middleware is registered for all API routes in `bootstrap/app.php`.

### Using Translations in Controllers

```php
use Illuminate\Support\Facades\App;

// Use the __() helper for translated messages
return $this->sendSuccess($data, __('messages.pets.created'));
return $this->sendError(__('messages.pets.not_found'), 404);

// With placeholders
return $this->sendError(__('messages.helper.city_country_mismatch', ['name' => $cityName]));
```

### Using Translations in Form Requests

```php
public function messages(): array
{
    return [
        'email.required' => __('validation.email.required'),
        'email.email' => __('validation.email.email'),
        'password.min' => __('validation.password.min'),
    ];
}
```

### Translation File Format (PHP)

`lang/en/messages.php`:

```php
<?php

return [
    'success' => 'Operation completed successfully.',

    'pets' => [
        'created' => 'Pet created successfully.',
        'not_found' => 'Pet not found.',
    ],

    // With placeholder
    'helper' => [
        'city_country_mismatch' => 'City :name does not belong to the specified country.',
    ],
];
```

Access nested keys with dot notation: `__('messages.pets.created')`

### API Endpoints

| Method | Endpoint           | Description                              | Auth |
| ------ | ------------------ | ---------------------------------------- | ---- |
| GET    | `/api/locale`      | Get current locale and supported locales | No   |
| PUT    | `/api/user/locale` | Update user's locale preference          | Yes  |

---

## Frontend Implementation

### Directory Structure

```
frontend/src/
├── i18n/
│   ├── index.ts              # i18next configuration
│   └── locales/
│       ├── en/
│       │   ├── common.json   # Shared UI strings
│       │   ├── auth.json     # Authentication strings
│       │   ├── pets.json     # Pet management strings
│       │   ├── settings.json # Settings page strings
│       │   └── validation.json # Form validation strings
│       └── ru/
│           ├── common.json
│           ├── auth.json
│           ├── pets.json
│           ├── settings.json
│           └── validation.json
├── components/
│   └── LanguageSwitcher.tsx  # Language selector component
├── hooks/
│   └── useLocaleSync.ts      # Syncs user locale from backend
└── lib/
    └── i18n-toast.ts         # i18n-aware toast wrapper
```

### Configuration

`src/i18n/index.ts` initializes i18next with:

- **Language detection**: Uses `i18next-browser-languagedetector` to detect from localStorage and browser settings
- **Namespaces**: `common`, `auth`, `pets`, `settings`, `validation`
- **Fallback**: Falls back to English for missing translations

### Using Translations in Components

```tsx
import { useTranslation } from "react-i18next";

function MyComponent() {
  const { t } = useTranslation("common"); // Use 'common' namespace

  return (
    <div>
      <h1>{t("app.name")}</h1>
      <button>{t("actions.save")}</button>
    </div>
  );
}
```

### Using Multiple Namespaces

```tsx
const { t } = useTranslation(["common", "auth"]);

// Access common namespace
t("common:actions.cancel");

// Access auth namespace
t("auth:login.title");
```

### Translation File Format (JSON)

`locales/en/common.json`:

```json
{
  "app": {
    "name": "Meo Mai Moi"
  },
  "actions": {
    "save": "Save",
    "cancel": "Cancel"
  },
  "time": {
    "minutesAgo": "{{count}} minute ago",
    "minutesAgo_other": "{{count}} minutes ago"
  }
}
```

### Interpolation

```tsx
// Simple interpolation
t("greeting", { name: "John" }); // "Hello, {{name}}" → "Hello, John"

// Pluralization
t("time.minutesAgo", { count: 1 }); // "1 minute ago"
t("time.minutesAgo", { count: 5 }); // "5 minutes ago"
```

### Language Switcher Component

Add to your UI (e.g., settings page, navbar):

```tsx
import { LanguageSwitcher } from "@/components/LanguageSwitcher";

function Settings() {
  return (
    <div>
      <h2>Language</h2>
      <LanguageSwitcher />
    </div>
  );
}
```

The component:

- Displays a dropdown with supported languages
- Updates i18next language immediately
- Persists preference to backend for authenticated users

### Locale Sync Hook

Use in your app's root to sync locale when user logs in:

```tsx
import { useLocaleSync } from "@/hooks/useLocaleSync";

function App() {
  useLocaleSync(); // Syncs user's saved locale preference

  return <RouterProvider router={router} />;
}
```

### i18n-Aware Toast Messages

```tsx
import { toast } from "@/lib/i18n-toast";

// Automatically translates the key
toast.success("common:messages.saved");
toast.error("auth:login.error");

// For pre-translated messages from API
toast.raw.success(apiResponse.message);
```

### Accept-Language Header

The Axios interceptor in `src/api/axios.ts` automatically adds the `Accept-Language` header to all API requests:

```typescript
api.interceptors.request.use((config) => {
  config.headers["Accept-Language"] = i18n.language || "en";
  return config;
});
```

---

## Adding New Translations

### Backend

1. Add the key to the English file first:

   `lang/en/messages.php`:

   ```php
   'new_feature' => [
       'created' => 'Feature created successfully.',
   ],
   ```

2. Add the same key to all other language files:

   `lang/ru/messages.php`:

   ```php
   'new_feature' => [
       'created' => 'Функция успешно создана.',
   ],
   ```

3. Use in code:
   ```php
   return $this->sendSuccess($data, __('messages.new_feature.created'));
   ```

### Frontend

1. Add the key to the English file:

   `locales/en/common.json`:

   ```json
   {
     "newFeature": {
       "title": "New Feature",
       "description": "This is a new feature"
     }
   }
   ```

2. Add the same key to all other language files:

   `locales/ru/common.json`:

   ```json
   {
     "newFeature": {
       "title": "Новая функция",
       "description": "Это новая функция"
     }
   }
   ```

3. Use in component:
   ```tsx
   const { t } = useTranslation("common");
   return <h1>{t("newFeature.title")}</h1>;
   ```

---

## Adding a New Language

### Step 1: Backend

1. Add the locale code to supported locales in:
   - `app/Http/Middleware/SetLocaleMiddleware.php`
   - `app/Http/Controllers/LocaleController.php`

   ```php
   private const SUPPORTED_LOCALES = ['en', 'ru', 'vi'];  // Add 'vi'
   ```

2. Create translation files:

   ```bash
   cp -r backend/lang/en backend/lang/vi
   ```

3. Translate all strings in `lang/vi/*.php`

### Step 2: Frontend

1. Update `src/i18n/index.ts`:

   ```typescript
   // Add imports
   import viCommon from './locales/vi/common.json'
   import viAuth from './locales/vi/auth.json'
   // ... other imports

   // Update supportedLocales
   export const supportedLocales = ['en', 'ru', 'vi'] as const

   // Update localeNames
   export const localeNames: Record<SupportedLocale, string> = {
     en: 'English',
     ru: 'Русский',
     vi: 'Tiếng Việt',
   }

   // Add to resources
   resources: {
     en: { ... },
     ru: { ... },
     vi: {
       common: viCommon,
       auth: viAuth,
       pets: viPets,
       settings: viSettings,
       validation: viValidation,
     },
   }
   ```

2. Create translation files:

   ```bash
   cp -r frontend/src/i18n/locales/en frontend/src/i18n/locales/vi
   ```

3. Translate all strings in `locales/vi/*.json`

### Step 3: Database Migration (if needed)

The `locale` column is `VARCHAR(5)`, which supports standard locale codes like `vi`, `pt-BR`, etc. No migration needed.

---

## Namespace Reference

### Frontend Namespaces

| Namespace    | Purpose              | Example Keys                                             |
| ------------ | -------------------- | -------------------------------------------------------- |
| `common`     | Shared UI elements   | `actions.save`, `nav.home`, `errors.generic`             |
| `auth`       | Authentication flows | `login.title`, `register.submit`, `forgotPassword.email` |
| `pets`       | Pet management       | `form.name`, `status.active`, `messages.created`         |
| `settings`   | Settings pages       | `tabs.profile`, `security.changePassword`                |
| `validation` | Form validation      | `email.required`, `password.min`                         |

### Backend Files

| File             | Purpose               | Example Keys                         |
| ---------------- | --------------------- | ------------------------------------ |
| `messages.php`   | API response messages | `auth.login_success`, `pets.created` |
| `validation.php` | Form validation       | `email.required`, `password.min`     |

---

## Best Practices

### Key Naming

1. **Use dot notation** for nested structures
2. **Be specific**: `auth.login.submit` not `submit`
3. **Use namespaces**: Separate concerns into different files
4. **Consistent casing**: Use camelCase for keys

### Placeholders

```json
// Good: Named placeholders
{ "greeting": "Hello, {{name}}!" }

// Good: Pluralization
{ "items": "{{count}} item", "items_other": "{{count}} items" }
```

### Don't Translate

- **Technical terms**: API, URL, HTTP
- **Brand names**: Meo Mai Moi
- **Code/IDs**: User IDs, error codes
- **Dates/Numbers**: Use formatting libraries instead

### Testing

- Always test with both languages
- Check for text overflow in UI
- Verify placeholder substitution works
- Test RTL layouts if adding RTL languages

### Maintaining Translation Files

Regular maintenance of translation files helps keep your codebase clean and prevents accumulation of unused keys.

#### Scanning for New Keys

To automatically scan your source code for new translation keys and add them to your JSON files:

```bash
# Scan code and update translation files
bun run i18n:scan
```

This uses `i18next-scanner` to find `t()` and `Trans` usage and update your JSON resources with `__STRING_NOT_TRANSLATED__` placeholders.

#### Finding Unused Translation Keys

Use the built-in script to identify unused translation keys:

```bash
# Find unused keys (safe - just reports)
bun run i18n:unused
```

This will scan your entire codebase and report:

- Total number of translation keys found
- Number of keys used in source code
- List of unused keys grouped by file

#### Removing Unused Translation Keys

After reviewing the unused keys list, you can remove them automatically:

```bash
# Remove unused keys (destructive - backup first!)
bun run i18n:clean
```

**⚠️ Important**: Always backup your translation files before running `i18n:clean` and test thoroughly afterward.

#### Best Practices for Cleanup

1. **Commit first**: Always commit changes before cleanup
2. **Gradual removal**: Remove keys in batches rather than all at once
3. **Team coordination**: Communicate with team members about key removals
4. **Test thoroughly**: Verify the app works after removal
5. **Regular maintenance**: Run cleanup periodically (e.g., before releases)

#### Managing `__STRING_NOT_TRANSLATED__` Placeholders

The i18next-scanner automatically adds `__STRING_NOT_TRANSLATED__` placeholders when it finds translation keys in your code that don't exist in your JSON files. However, not all placeholders are necessary:

**Common Sources of Unnecessary Placeholders:**
- **Auto-generated pluralization variants**: Scanner creates `_one`, `_other` forms even when English doesn't use them
- **Unused keys**: Keys that were removed from code but still exist in translation files
- **Over-aggressive scanning**: Scanner finds keys in comments, test files, or unused code paths

**Cleaning Up Placeholders:**

1. **Identify which placeholders are actually needed:**
   ```bash
   # Search for usage of specific keys in your codebase
   grep -r "t('auth.login.title')" frontend/src/
   ```

2. **Use the cleanup script** (if available):
   ```bash
   # Run the placeholder cleanup utility
   node frontend/scripts/clean-translation-placeholders.js
   ```

3. **Manual cleanup approach:**
   - Remove pluralization variants that don't exist in English (e.g., `redirecting_one`, `redirecting_other`)
   - Translate keys that are actually used in the codebase
   - Remove keys that aren't found in any source files

**Russian Pluralization Rules:**
When translating to Russian, use proper pluralization forms:
- `_one`: 1, 21, 31, 41, etc. (1 item)
- `_few`: 2-4, 22-24, 32-34, etc. (2-4 items)  
- `_many`: 0, 5-20, 25-30, etc. (5+ items)
- `_other`: Fallback form

Example:
```json
{
  "cooldownMessage_one": "Подождите {{count}} секунду",
  "cooldownMessage_few": "Подождите {{count}} секунды", 
  "cooldownMessage_many": "Подождите {{count}} секунд"
}
```

**⚠️ Warning about `i18n:clean`:**
The `bun run i18n:clean` command can be overly aggressive and remove keys that are actually used in the codebase. Always:
- Create a backup before running it
- Review the list of "unused" keys carefully
- Test your application thoroughly after cleanup
- Consider using it only for major cleanups, not regular maintenance

---

## Troubleshooting

### Translation Not Showing

1. Check the key exists in the JSON/PHP file
2. Verify the namespace is correct
3. Check for typos in the key path
4. Ensure the language file is imported in `i18n/index.ts`

### Accept-Language Header Not Working

1. Check the Axios interceptor is configured
2. Verify `i18n.language` returns the expected value
3. Check browser DevTools Network tab for the header

### User Locale Not Persisting

1. Verify the user is authenticated
2. Check the `/api/user/locale` endpoint works
3. Ensure `locale` is in the User model's `$fillable`

### Middleware Not Setting Locale

1. Check middleware is registered in `bootstrap/app.php`
2. Verify the `Accept-Language` header is being sent
3. Check if user's DB locale is overriding the header

### Too Many `__STRING_NOT_TRANSLATED__` Placeholders

If you see many placeholders appearing after running `bun run i18n:scan`:

1. **Check if they're actually needed**: Search your codebase for the key usage
2. **Scanner over-generation**: The scanner may create unnecessary pluralization forms
3. **Recent code changes**: New features may have added many untranslated keys
4. **Configuration issue**: Scanner config might be too aggressive

**Quick diagnosis:**
```bash
# Count placeholders
grep -r "__STRING_NOT_TRANSLATED__" frontend/src/i18n/locales/ru/ | wc -l

# Find which files have the most
grep -r "__STRING_NOT_TRANSLATED__" frontend/src/i18n/locales/ru/ | cut -d: -f1 | sort | uniq -c | sort -nr

# Check if a specific key is used in code
grep -r "t('auth.someKey')" frontend/src/
```

### Translations Not Loading After Cleanup

If translations stop working after running cleanup scripts:

1. **Check JSON validity**: Ensure all JSON files are still valid
2. **Verify key structure**: Make sure nested objects weren't broken
3. **Check imports**: Ensure all locale files are still imported in `i18n/index.ts`
4. **Restore from backup**: Use the backup created before cleanup

```bash
# Validate JSON files
node -e "JSON.parse(require('fs').readFileSync('frontend/src/i18n/locales/ru/auth.json', 'utf8')); console.log('Valid JSON')"

# Restore from backup if needed
cp -r frontend/src/i18n/locales.backup/* frontend/src/i18n/locales/
```

---

## Related Files

### Backend

- `app/Http/Middleware/SetLocaleMiddleware.php`
- `app/Http/Controllers/LocaleController.php`
- `app/Models/User.php`
- `lang/en/messages.php`, `lang/en/validation.php`
- `lang/ru/messages.php`, `lang/ru/validation.php`
- `routes/api.php` (locale routes)
- `bootstrap/app.php` (middleware registration)

### Frontend

- [src/i18n/index.ts](src/i18n/index.ts)
- [src/i18n/locales/en/\*.json](src/i18n/locales/en/*.json)
- [src/i18n/locales/ru/\*.json](src/i18n/locales/ru/*.json)
- [src/components/LanguageSwitcher.tsx](src/components/LanguageSwitcher.tsx)
- [src/hooks/useLocaleSync.ts](src/hooks/useLocaleSync.ts)
- [src/lib/i18n-toast.ts](src/lib/i18n-toast.ts)
- [src/api/axios.ts](src/api/axios.ts) (Accept-Language interceptor)
- [frontend/scripts/find-unused-translations.cjs](frontend/scripts/find-unused-translations.cjs)
- [frontend/scripts/remove-unused-translations.cjs](frontend/scripts/remove-unused-translations.cjs)
- [frontend/scripts/clean-translation-placeholders.js](frontend/scripts/clean-translation-placeholders.js)
- [frontend/i18next-scanner.config.cjs](frontend/i18next-scanner.config.cjs)
