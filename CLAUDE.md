# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Meo Mai Moi is a pet care management platform with rehoming features. It's a monorepo with a Laravel 12 backend API and React 19 frontend SPA. PostgreSQL only (no SQLite).

## Quick Commands

### Development

```bash
./utils/deploy.sh --seed          # Start everything with sample data
docker compose up -d --build      # Manual Docker start
```

### Backend (from backend/)

```bash
php artisan test --parallel       # Run tests
composer phpstan                  # Static analysis (Level 5)
composer deptrac                  # Architecture validation
./vendor/bin/pint                 # Format code
php artisan l5-swagger:generate   # Regenerate OpenAPI spec
```

### Frontend (from frontend/)

```bash
bun run test:minimal              # Fast test run (minimal output)
bun run test                      # Verbose test run
bun run typecheck                 # TypeScript check
bun run lint                      # ESLint
bun run api:generate              # Regenerate API client from OpenAPI
bun run e2e                       # E2E tests. docs/e2e.md for details
```

### Root Workspace

```bash
bun run api:generate              # Regenerate both OpenAPI spec and frontend client
bun run api:check                 # Verify generated code matches spec
```

## Architecture

### Backend Layers (Enforced by Deptrac)

```
Http (Controllers, Middleware, Requests, Resources)
  ↓
Services (Business Logic)
  ↓
Domain (Models, Enums, Policies)
```

- **Controllers are thin** - delegate to Services
- **All endpoints** use `ApiResponseTrait` for standardized `{ success, data, message }` envelope
- **Authorization** via Policies with `$user->can(...)`
- **OpenAPI annotations** (`#[OA\*]`) on controllers generate the spec

### Frontend Structure

```
src/
├── api/generated/     # Auto-generated by Orval (DO NOT EDIT)
├── components/ui/     # shadcn/ui primitives
├── components/        # Feature components
├── pages/             # Route pages (don't import other pages)
├── hooks/             # Custom React hooks
└── lib/               # Utilities
```

- **State**: React Query (server), React Hook Form (forms), AuthProvider (auth context)
- **API Client**: Generated via Orval from OpenAPI spec - run `bun run api:generate` after backend API changes

### Key Patterns

**API Response Envelope** - All backend endpoints return:

```json
{ "success": true, "data": {}, "message": "..." }
```

**Pet Relationships** - The `PetRelationship` model supports multiple concurrent relationship types (owner, foster, editor, viewer) for flexible pet sharing.

**App Version Detection** - Two complementary mechanisms detect new deploys:
- **API version header**: `AppVersionHeader` middleware attaches `X-App-Version` (from `config/version.php`) to every API response. The Axios interceptor in `axios.ts` remembers the first version seen and fires a callback on mismatch. The `useVersionCheck` hook shows a persistent toast with Reload/Later (30-min snooze on dismiss).
- **PWA service worker**: Detects frontend asset changes (new JS bundles). Checks hourly + on window focus. The `usePwaUpdate` hook shows a similar toast.
- When bumping the version: update `backend/config/version.php`, and ensure `X-App-Version` is listed in `cors.php` `exposed_headers`.

## Testing

- **Backend tests** require `PetTypeSeeder` to run for pet-related tests
- **E2E tests** use MailHog for real email testing (UI at http://localhost:8025)
- **MSW handlers** in frontend must mirror the `{ data: ... }` API shape

## Important Files

- `backend/app/Traits/ApiResponseTrait.php` - Response standardization
- `frontend/src/api/orval-mutator.ts` - Custom Axios mutator for envelope handling
- `backend/deptrac.yaml` - Architectural layer rules
- `utils/deploy.sh` - Single deployment entry point
- `frontend/src/i18n/index.ts` - i18n configuration and supported locales
- `docs/i18n.md` - Full i18n implementation guide
- `backend/config/version.php` - App version (exposed via `X-App-Version` header)
- `backend/app/Http/Middleware/AppVersionHeader.php` - Attaches version header to API responses
- `frontend/src/hooks/use-version-check.tsx` - Version mismatch toast with snooze

## Access Points

- App: http://localhost:8000
- Admin: http://localhost:8000/admin (admin@catarchy.space / password)
- API Docs: http://localhost:8000/api/documentation

## Internationalization (i18n)

Supports English (`en`), Russian (`ru`), Ukrainian (`uk`), Vietnamese (`vi`).

**Frontend** (react-i18next):

```tsx
const { t } = useTranslation("common"); // Namespaces: common, auth, pets, settings, validation
return <button>{t("actions.save")}</button>;
```

- Translation files: `frontend/src/i18n/locales/{en,ru}/*.json`
- Language switcher: `src/components/LanguageSwitcher.tsx`

**Backend** (Laravel):

```php
return $this->sendSuccess($data, __('messages.pets.created'));
```

- Translation files: `backend/lang/{en,ru}/*.php`
- Locale set via `Accept-Language` header (sent automatically by frontend)

**Adding translations**: Add keys to both `en` and `ru` files simultaneously.

## Workflow Notes

- Frontend builds into `backend/public/build/` via Docker multi-stage build
- Email config is database-driven via Filament admin (overrides .env)
- Run `bun run api:generate` after any backend API changes to sync frontend types
- Bump version in `backend/config/version.php` on each release — frontend clients auto-detect the change and prompt users to reload
